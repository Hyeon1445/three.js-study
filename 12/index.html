<!DOCTYPE html>
<html lang="en">
  <head>
    <title>positional audio</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
  </head>
  <body>
    <div id="overlay">
      <button id="startButton">Play</button>
    </div>

    <script type="module">
      import * as THREE from 'https://cdn.skypack.dev/three@0.135.0'
      import { GUI } from "https://cdn.skypack.dev/three@0.134.0/examples/jsm/libs/dat.gui.module.js"
      import { FirstPersonControls } from "https://unpkg.com/three@0.124.0/examples/jsm/controls/FirstPersonControls.js"

      let camera, controls, scene, renderer, light
      let material1, material2, material3
      let analyser1, analyser2, analyser3

      const clock = new THREE.Clock()

      const startButton = document.getElementById("startButton")
      startButton.addEventListener("click", init)

      function init() {
        const overlay = document.getElementById("overlay")
        overlay.remove()
        const aspectRatio = window.innerWidth / window.innerHeight
        camera = new THREE.PerspectiveCamera(50, aspectRatio, 1, 10000)
        camera.position.set(0, 25, 0)

        const listener = new THREE.AudioListener()
        camera.add(listener)

        scene = new THREE.Scene()
        scene.fog = new THREE.FogExp2(0x000000, 0.0025)

        light = new THREE.DirectionalLight(0xffffff)
        light.position.set(0, 0.5, 1).normalize()
        scene.add(light)

        const sphere = new THREE.SphereBufferGeometry(20, 32, 16)

        material1 = new THREE.MeshPhongMaterial({
          color: 0xffaa00,
          flatShading: true,
          shininess: 0,
        })
        material2 = new THREE.MeshPhongMaterial({
          color: 0xff2200,
          flatShading: true,
          shininess: 0,
        })
        material3 = new THREE.MeshPhongMaterial({
          color: 0x6622aa,
          flatShading: true,
          shininess: 0,
        })

        const audioLoader = new THREE.AudioLoader()

        const mesh1 = new THREE.Mesh(sphere, material1)
        mesh1.position.set(-250, 30, 0)
        scene.add(mesh1)

        const sound1 = new THREE.PositionalAudio(listener)
        audioLoader.load("358232_j_s_song.ogg", function (buffer) {
          sound1.setBuffer(buffer)
          sound1.setRefDistance(20)
          sound1.play()
        })
        mesh1.add(sound1)

        const mesh2 = new THREE.Mesh(sphere, material2)
        mesh2.position.set(250, 30, 0)
        scene.add(mesh2)

        const sound2 = new THREE.PositionalAudio(listener)
        audioLoader.load("376737_Skullbeatz___Bad_Cat_Maste.ogg",function (buffer) {
            sound2.setBuffer(buffer)
            sound2.setRefDistance(20)
            sound2.play()
          }
        )
        mesh2.add(sound2)

        // analysers
        analyser1 = new THREE.AudioAnalyser(sound1, 32)
        analyser2 = new THREE.AudioAnalyser(sound2, 32)

        // ground
        const helper = new THREE.GridHelper(1000, 10, 0x444444, 0x444444)
        helper.position.y = 0.1
        scene.add(helper)

        renderer = new THREE.WebGLRenderer({ antialias: true })
        renderer.setPixelRatio(window.devicePixelRatio)
        renderer.setSize(window.innerWidth, window.innerHeight)
        document.body.appendChild(renderer.domElement)


        controls = new FirstPersonControls(camera, renderer.domElement)
        controls.movementSpeed = 70
        controls.lookSpeed = 0.05
        controls.noFly = true
        controls.lookVertical = false

        animate()
      }

      function animate() {
        requestAnimationFrame(animate)
        render()
      }

      function render() {
        const delta = clock.getDelta()

        controls.update(delta)

        material1.emissive.b = analyser1.getAverageFrequency() / 256
        material2.emissive.b = analyser2.getAverageFrequency() / 256

        renderer.render(scene, camera)
      }
    </script>
  </body>
</html>
